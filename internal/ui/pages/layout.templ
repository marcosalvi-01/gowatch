// Package pages contains templated page layouts and views for the web interface.
package pages

import (
	"github.com/marcosalvi-01/gowatch/internal/ui/components/sidebar"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/avatar"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/button"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/calendar"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/chart"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/checkbox"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/collapsible"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/datepicker"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/dialog"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/icon"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/input"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/popover"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/rating"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/selectbox"
	templSidebar "github.com/marcosalvi-01/gowatch/internal/ui/templui/sidebar"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/skeleton"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/textarea"
	"github.com/marcosalvi-01/gowatch/internal/ui/templui/toast"
)

templ Layout() {
	<!DOCTYPE html>
	<html lang="en">
		<head>
			<meta charset="utf-8"/>
			<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
			<title>Gowatch</title>
			<link rel="stylesheet" href="/static/css/output.css"/>
			@Scripts()
			@Favicons()
		</head>
		<body class="bg-background">
			@templSidebar.Layout(templSidebar.LayoutProps{
				Class: "w-full h-screen",
			}) {
				// by default show a loading version, when loading get the real sidebar content
				<div id="sidebar-content" hx-get="/htmx/sidebar" hx-target="this" hx-swap="innerHTML" hx-trigger="refreshSidebar from:body, load">
					@sidebar.SidebarLoading(false)
				</div>
				@templSidebar.Inset() {
					<div id="toast"></div>
					// Header
					<div class="flex items-center gap-2 p-2 flex-shrink-0 sticky z-10 top-0 border-b-1 bg-background">
						<div class="md:hidden">
							@templSidebar.Trigger(templSidebar.TriggerProps{
								Target: "sidebar",
							})
						</div>
						@SearchBar("")
						@ThemeSwitcher()
					</div>
					<div class="relative flex flex-1 flex-col min-w-0 overflow-hidden h-full">
						@HomeLoading()
						@WatchedLoading()
						@StatsLoading()
						@MovieLoading()
						@SearchLoading()
						<div id="main-scroll-container" class="flex flex-1 flex-col overflow-auto w-full">
							<div id="main-content" class="p-4 w-full max-w-full">
								{ children... }
							</div>
						</div>
					</div>
				}
			}
		</body>
	</html>
}

templ AuthLayout() {
	<!DOCTYPE html>
	<html lang="en">
		<head>
			<meta charset="utf-8"/>
			<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
			<title>Gowatch</title>
			<link rel="stylesheet" href="/static/css/output.css"/>
			@Scripts()
			@Favicons()
		</head>
		<body class="bg-background min-h-screen flex items-center justify-center">
			<div class="w-full max-w-md p-4">
				{ children... }
			</div>
			<div id="toast"></div>
		</body>
	</html>
}

templ mainContentLoading() {
	<div id="main-content-loading" class="htmx-indicator absolute inset-0 bg-background z-5 pointer-events-none">
		<div class="flex flex-col justify-center items-center h-full p-8">
			<div class="w-full max-w-3xl space-y-6">
				// Page title
				<div class="space-y-2">
					@skeleton.Skeleton(skeleton.Props{Class: "h-8 w-48 rounded-lg"})
					@skeleton.Skeleton(skeleton.Props{Class: "h-4 w-64 rounded-md"})
				</div>
				// Main content blocks
				<div class="space-y-4 pt-4">
					@skeleton.Skeleton(skeleton.Props{Class: "h-24 w-full rounded-lg"})
					@skeleton.Skeleton(skeleton.Props{Class: "h-24 w-full rounded-lg"})
					@skeleton.Skeleton(skeleton.Props{Class: "h-24 w-full rounded-lg"})
					@skeleton.Skeleton(skeleton.Props{Class: "h-24 w-full rounded-lg"})
				</div>
				// Bottom action area
				<div class="flex justify-between items-center pt-6">
					@skeleton.Skeleton(skeleton.Props{Class: "h-4 w-24 rounded-md"})
					@skeleton.Skeleton(skeleton.Props{Class: "h-10 w-28 rounded-lg"})
				</div>
			</div>
		</div>
	</div>
}

templ ThemeSwitcher() {
	@button.Button(button.Props{
		Variant: button.VariantGhost,
		Size:    button.SizeIcon,
		Attributes: templ.Attributes{
			"onclick":    "toggleTheme()",
			"aria-label": "Toggle theme",
		},
	}) {
		@icon.Moon(icon.Props{Class: "dark:hidden"})
		@icon.Sun(icon.Props{Class: "hidden dark:inline-block"})
	}
}

templ Scripts() {
	<script src="/static/js/htmx.min.js"></script>
	<script>
	  document.addEventListener("DOMContentLoaded", () => {
		// Re-initialize templUI components after HTMX swaps
		document.body.addEventListener("htmx:afterSwap", (e) => {
		  if (window.templUI) {
			Object.values(window.templUI).forEach(comp => {
			  comp.init?.(e.detail.elt);
			});
		  }
		});

		// Re-initialize components after out-of-band swaps
		document.body.addEventListener("htmx:oobAfterSwap", (e) => {
		  if (window.templUI) {
			Object.values(window.templUI).forEach(comp => {
			  comp.init?.(e.detail.target);
			});
		  }
		});
	});
	</script>
	@SidebarNavigationScript()
	@ThemeScript()
	// for the sidebar
	@templSidebar.Script()
	@popover.Script()
	@dialog.Script()
	@avatar.Script()
	@dialog.Script()
	@datepicker.Script()
	@calendar.Script()
	@toast.Script()
	@collapsible.Script()
	@textarea.Script()
	@chart.Script()
	@selectbox.Script()
	@input.Script()
	@checkbox.Script()
	@rating.Script()
}

templ SidebarNavigationScript() {
	<script>
	document.addEventListener("DOMContentLoaded", () => {
	  // Function to update active state based on a specific URL
	  function updateSidebarActiveState(url = window.location.pathname) {
		const allNavButtons = document.querySelectorAll(
		  "[data-tui-sidebar=menu-button][data-nav-url], [data-tui-sidebar=menu-sub-button][data-nav-url]"
		);

		// Reset all buttons
		allNavButtons.forEach(btn => {
		  btn.removeAttribute("data-tui-sidebar-active");
		});

		// Activate the button matching the URL
		allNavButtons.forEach(btn => {
		  if (btn.getAttribute("data-nav-url") === url) {
			btn.setAttribute("data-tui-sidebar-active", "true");
		  }
		});
	  }

	  // Set initial active state on full page load
	  updateSidebarActiveState();

	  // Single listener for all post-swap logic
	  document.body.addEventListener("htmx:afterSwap", (e) => {
		if (!e.detail.target) return;

		// Case 1: The sidebar itself was refreshed.
		// Re-apply the active state based on the current browser URL.
		if (e.detail.target.id === "sidebar-content") {
		  updateSidebarActiveState(window.location.pathname);
		  return;
		}

		// Case 2: A main navigation link was clicked.
		// The request was triggered by an element inside the sidebar menu.
		// We only update the active state for these explicit navigation events.
		const trigger = e.detail.elt;
		const isNavigation = trigger && trigger.closest('[data-tui-sidebar="menu"], [data-tui-sidebar="menu-sub"]');
		
		if (isNavigation) {
			const newUrl = e.detail.pathInfo?.requestPath || window.location.pathname;
			updateSidebarActiveState(newUrl);
		}
	  });


	  // Handle browser back/forward navigation
	  window.addEventListener("popstate", () => {
		updateSidebarActiveState(window.location.pathname);
	  });

	  // Keep click handler for immediate UI feedback before htmx swap
	  document.body.addEventListener("click", (e) => {
		const navButton = e.target.closest("[data-nav-url]");
		if (navButton) {
		  const targetUrl = navButton.getAttribute("data-nav-url");
		  if (targetUrl) {
			updateSidebarActiveState(targetUrl);
		  }
		}
	  });
	});
	</script>
}

templ ThemeScript() {
	<script>
	(() => {
	  const root = document.documentElement;
	  const saved = localStorage.getItem('theme');
	  const shouldBeDark = saved ? saved === 'dark' : true;
	  if (shouldBeDark) {
	    root.classList.add('dark');
	  }
	  window.toggleTheme = () => {
	    const isDark = root.classList.toggle('dark');
	    localStorage.setItem('theme', isDark ? 'dark' : 'light');
	  };
	})();
	</script>
}

templ Favicons() {
	<link rel="icon" type="image/svg+xml" href="/static/favicon.svg"/>
	<meta name="theme-color" content="#ffffff"/>
}

templ skeletonDashboard() {
	<div>
		<div class="grid gap-6 md:grid-cols-3">
			for _ = range 3 {
				<div class="p-4">
					@skeleton.Skeleton(skeleton.Props{Class: "h-4 w-20 mb-2"})
					@skeleton.Skeleton(skeleton.Props{Class: "h-8 w-24 mb-4"})
					<div class="flex items-center gap-2">
						@skeleton.Skeleton(skeleton.Props{Class: "h-4 w-12"})
						@skeleton.Skeleton(skeleton.Props{Class: "h-4 w-4"})
					</div>
				</div>
			}
		</div>
		<div class="mt-4 p-4">
			@skeleton.Skeleton(skeleton.Props{Class: "h-5 w-1/3 mb-6"})
			@skeleton.Skeleton(skeleton.Props{Class: "h-[240px] w-full rounded-md"})
		</div>
	</div>
}

templ SearchBar(searchContent string) {
	<div class="relative flex items-center flex-1">
		@icon.Search(icon.Props{
			Class: "absolute left-3 text-muted-foreground",
			Size:  20,
		})
		@input.Input(input.Props{
			Type:        input.TypeSearch,
			Placeholder: "Search Movies...",
			Class:       "pl-10",
			Value:       searchContent,
			Name:        "q",
			Attributes: templ.Attributes{
				"hx-get":       "/search",
				"hx-trigger":   "keyup[key=='Enter']",
				"hx-target":    "#main-content",
				"hx-swap":      "innerHTML scroll:#main-scroll-container:top",
				"hx-push-url":  "true",
				"hx-include":   "this",
				"hx-indicator": "#search-loading",
			},
		})
	</div>
}
